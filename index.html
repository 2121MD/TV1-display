<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>School Display - Fixed</title>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            color: white; 
            font-family: Arial, sans-serif; 
            overflow: hidden;
        }
        /* Full screen containers */
        #slide-container, #bus-container {
            width: 100vw; height: 100vh;
            position: absolute; top: 0; left: 0;
            border: 0;
        }
        
        iframe { width: 100%; height: 100%; border: 0; }
        
        /* Bus Screen Styling */
        #bus-container { 
            display: none; 
            background: black; 
            padding: 40px; 
            box-sizing: border-box; 
        }
        .header {
            font-size: 5vw; 
            color: #ffdd00; 
            text-align: center; 
            margin-bottom: 40px; 
            font-weight: bold;
        }
        .bus-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background-color: #1a1a1a;
            margin-bottom: 20px; 
            padding: 20px;
            border-radius: 15px;
            font-size: 3.5vw; 
        }
        .line { 
            background-color: #d91e18; 
            color: white;
            padding: 10px 30px;
            border-radius: 8px;
            font-weight: bold;
            min-width: 80px;
            text-align: center;
        }
        .dest { flex-grow: 1; margin-left: 30px; }
        .time { color: #00ff00; font-weight: bold; }
        
        /* Error box styling (just in case) */
        #error-box {
            position: fixed; bottom: 10px; left: 10px;
            color: gray; font-size: 12px; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="slide-container">
        <iframe id="slide-frame" src=""></iframe>
    </div>

    <div id="bus-container">
        <div class="header">Bus Times: Marabou</div>
        <div id="bus-list">Loading...</div>
    </div>
    
    <div id="error-box"></div>

    <script>
        // --- 1. SETTINGS (DO NOT DELETE) ---
        const SLIDE_URL = "https://docs.google.com/presentation/d/e/2PACX-1vQwjmE1FkRhNx5nQYTXnp6GILgPBUGh0L1qHyrPiBH92eyt_2XiUNhbWCRengOVVzJ5IXHZqP8S1bWI/embed?start=true&loop=true&delayms=10000";
        const SITE_ID = "1606";
        const BUS_FILTER = "Upplands VÃ¤sby";
        const SLIDE_TIME = 30000; // 30 seconds
        const BUS_TIME = 15000;   // 15 seconds

        // --- 2. MAIN LOGIC ---
        const slideFrame = document.getElementById('slide-frame');
        const slideDiv = document.getElementById('slide-container');
        const busDiv = document.getElementById('bus-container');
        const busList = document.getElementById('bus-list');

        // Initialize
        try {
            slideFrame.src = SLIDE_URL;
            
            // Start the loop
            setTimeout(showBuses, SLIDE_TIME);
        } catch (e) {
            document.getElementById('error-box').innerText = "Setup Error: " + e.message;
        }

        function showSlides() {
            busDiv.style.display = 'none';
            slideDiv.style.display = 'block';
            setTimeout(showBuses, SLIDE_TIME);
        }

        function showBuses() {
            slideDiv.style.display = 'none';
            busDiv.style.display = 'block';
            fetchBusData();
            setTimeout(showSlides, BUS_TIME);
        }

        async function fetchBusData() {
            busList.innerHTML = "<div style='text-align:center;'>Updating...</div>";
            try {
                // Using corsproxy.io
                const target = `https://transport.integration.sl.se/v1/sites/${SITE_ID}/departures?transport_authority_id=1`;
                const proxy = "https://corsproxy.io/?" + encodeURIComponent(target);
                
                const response = await fetch(proxy);
                if (!response.ok) throw new Error("Network Error");
                
                const data = await response.json();
                const buses = data.departures || [];
                
                let html = "";
                let count = 0;
                
                buses.forEach(b => {
                    if (b.line.transport_mode === 'BUS' && b.destination.includes(BUS_FILTER)) {
                        if (count < 4) {
                            html += `
                            <div class="bus-row">
                                <div class="line">${b.line.designation}</div>
                                <div class="dest">${b.destination}</div>
                                <div class="time">${b.display}</div>
                            </div>`;
                            count++;
                        }
                    }
                });

                if (count === 0) html = "<div style='text-align:center; margin-top:50px;'>No buses found.</div>";
                busList.innerHTML = html;

            } catch (err) {
                busList.innerHTML = `<div style='text-align:center; color:red;'>
                    Error loading buses.<br>
                    <small>${err.message}</small>
                </div>`;
            }
        }
    </script>
</body>
</html>
