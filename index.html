<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>School Display - AllOrigins</title>
    <style>
        body { 
            margin: 0; 
            background-color: #000; 
            color: white; 
            font-family: Arial, sans-serif; 
            overflow: hidden;
        }
        #slide-container, #bus-container {
            width: 100vw; height: 100vh;
            position: absolute; top: 0; left: 0;
            border: 0;
        }
        iframe { width: 100%; height: 100%; border: 0; }
        
        #bus-container { 
            display: none; 
            background: black; 
            padding: 40px; 
            box-sizing: border-box; 
        }
        .header {
            font-size: 5vw; 
            color: #ffdd00; 
            text-align: center; 
            margin-bottom: 40px; 
            font-weight: bold;
        }
        .bus-row { 
            display: flex; justify-content: space-between; align-items: center;
            background-color: #1a1a1a; margin-bottom: 20px; padding: 20px;
            border-radius: 15px; font-size: 3.5vw; 
        }
        .line { 
            background-color: #d91e18; color: white; padding: 10px 30px;
            border-radius: 8px; font-weight: bold; min-width: 80px; text-align: center;
        }
        .dest { flex-grow: 1; margin-left: 30px; }
        .time { color: #00ff00; font-weight: bold; }
        
        #debug-log {
            position: fixed; bottom: 5px; left: 5px; color: gray; font-size: 10px; z-index: 9999;
        }
    </style>
</head>
<body>

    <div id="slide-container">
        <iframe id="slide-frame" src=""></iframe>
    </div>

    <div id="bus-container">
        <div class="header">Bus Times: Marabou</div>
        <div id="bus-list">Loading...</div>
    </div>
    
    <div id="debug-log"></div>

    <script>
        // --- SETTINGS ---
        const SLIDE_URL = "https://docs.google.com/presentation/d/e/2PACX-1vQwjmE1FkRhNx5nQYTXnp6GILgPBUGh0L1qHyrPiBH92eyt_2XiUNhbWCRengOVVzJ5IXHZqP8S1bWI/embed?start=true&loop=true&delayms=10000";
        const SITE_ID = "1606";
        const BUS_FILTER = "Upplands VÃ¤sby";
        const SLIDE_TIME = 30000;
        const BUS_TIME = 15000;

        // --- LOGIC ---
        const slideFrame = document.getElementById('slide-frame');
        const slideDiv = document.getElementById('slide-container');
        const busDiv = document.getElementById('bus-container');
        const busList = document.getElementById('bus-list');
        const debugLog = document.getElementById('debug-log');

        // Start
        slideFrame.src = SLIDE_URL;
        setTimeout(showBuses, SLIDE_TIME);

        function showSlides() {
            busDiv.style.display = 'none';
            slideDiv.style.display = 'block';
            setTimeout(showBuses, SLIDE_TIME);
        }

        function showBuses() {
            slideDiv.style.display = 'none';
            busDiv.style.display = 'block';
            fetchBusData();
            setTimeout(showSlides, BUS_TIME);
        }

        async function fetchBusData() {
            busList.innerHTML = "<div style='text-align:center;'>Updating...</div>";
            const slUrl = `https://transport.integration.sl.se/v1/sites/${SITE_ID}/departures?transport_authority_id=1`;
            
            try {
                // Try Strategy 1: AllOrigins (Different proxy)
                debugLog.innerText = "Trying: AllOrigins...";
                const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(slUrl);
                
                let response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("AllOrigins blocked");
                
                let data = await response.json();
                // AllOrigins wraps the data in a "contents" string, so we parse it again
                let realData = JSON.parse(data.contents);
                
                renderBuses(realData);
                debugLog.innerText = "Success: AllOrigins";

            } catch (e1) {
                console.error("Proxy failed", e1);
                
                // Try Strategy 2: Direct Connection (In case SL allows it now)
                try {
                    debugLog.innerText = "Proxy failed. Trying Direct...";
                    let response2 = await fetch(slUrl);
                    if (!response2.ok) throw new Error("Direct blocked");
                    let data2 = await response2.json();
                    renderBuses(data2);
                    debugLog.innerText = "Success: Direct";
                    
                } catch (e2) {
                    busList.innerHTML = `<div style='text-align:center; color:red; font-size: 2vw;'>
                        Network Blocked.<br>
                        <span style="color:white; font-size: 1.5vw;">The school internet is blocking the connection.</span>
                    </div>`;
                    debugLog.innerText = "CRITICAL: All methods failed.";
                }
            }
        }

        function renderBuses(data) {
            const buses = data.departures || [];
            let html = "";
            let count = 0;
            
            buses.forEach(b => {
                if (b.line.transport_mode === 'BUS' && b.destination.includes(BUS_FILTER)) {
                    if (count < 4) {
                        html += `
                        <div class="bus-row">
                            <div class="line">${b.line.designation}</div>
                            <div class="dest">${b.destination}</div>
                            <div class="time">${b.display}</div>
                        </div>`;
                        count++;
                    }
                }
            });

            if (count === 0) html = "<div style='text-align:center; margin-top:50px;'>No buses found.</div>";
            busList.innerHTML = html;
        }
    </script>
</body>
</html>
